<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Nginx, Varnish and Wordpress with SSL Termination | Matthew Hartstonge</title>
<meta name=keywords content="DevOps,Nginx,WordPress,Varnish"><meta name=description content="TL;DR Assuming you&rsquo;ve already got your reverse proxy running, in wp-config.php add the following:
1 2 3 4 5 6 7 8 9 <?php /** TLS/HTTPS fixes **/ // in some setups HTTP_X_FORWARDED_PROTO might contain a comma-separated list // e.g. http,https so check for https existence. if (strpos($_SERVER['HTTP_X_FORWARDED_PROTO'], 'https') !== false) { // update HTTPS server variable to always 'pretend' incoming requests were // performed via the HTTPS protocol. $_SERVER['HTTPS']='on'; } If you&rsquo;re getting desperate:"><meta name=author content="Matthew Hartstonge"><link rel=canonical href=https://blog.mykro.co.nz/posts/2020-07-06-nginx-varnish-wordpress-ssl-termination/><link crossorigin=anonymous href=/assets/css/stylesheet.49e1a9d11d71e94986513bdf8be953c1be6edeee520b367d13aa6b887bafe4f5.css integrity="sha256-SeGp0R1x6UmGUTvfi+lTwb5u3u5SCzZ9E6priHuv5PU=" rel="preload stylesheet" as=style><link rel=icon href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=250"><link rel=icon type=image/png sizes=16x16 href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=16"><link rel=icon type=image/png sizes=32x32 href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=32"><link rel=apple-touch-icon href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=192"><link rel=mask-icon href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=64"><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.mykro.co.nz/posts/2020-07-06-nginx-varnish-wordpress-ssl-termination/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-3N8ZQ0TS42"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3N8ZQ0TS42")}</script><meta property="og:title" content="Nginx, Varnish and Wordpress with SSL Termination"><meta property="og:description" content="TL;DR Assuming you&rsquo;ve already got your reverse proxy running, in wp-config.php add the following:
1 2 3 4 5 6 7 8 9 <?php /** TLS/HTTPS fixes **/ // in some setups HTTP_X_FORWARDED_PROTO might contain a comma-separated list // e.g. http,https so check for https existence. if (strpos($_SERVER['HTTP_X_FORWARDED_PROTO'], 'https') !== false) { // update HTTPS server variable to always 'pretend' incoming requests were // performed via the HTTPS protocol. $_SERVER['HTTPS']='on'; } If you&rsquo;re getting desperate:"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.mykro.co.nz/posts/2020-07-06-nginx-varnish-wordpress-ssl-termination/"><meta property="og:image" content="https://blog.mykro.co.nz/images/wordpress-ssl.jpeg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-06T22:13:09+12:00"><meta property="article:modified_time" content="2020-07-06T22:13:09+12:00"><meta property="og:site_name" content="Matthew Hartstonge"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.mykro.co.nz/images/wordpress-ssl.jpeg"><meta name=twitter:title content="Nginx, Varnish and Wordpress with SSL Termination"><meta name=twitter:description content="TL;DR Assuming you&rsquo;ve already got your reverse proxy running, in wp-config.php add the following:
1 2 3 4 5 6 7 8 9 <?php /** TLS/HTTPS fixes **/ // in some setups HTTP_X_FORWARDED_PROTO might contain a comma-separated list // e.g. http,https so check for https existence. if (strpos($_SERVER['HTTP_X_FORWARDED_PROTO'], 'https') !== false) { // update HTTPS server variable to always 'pretend' incoming requests were // performed via the HTTPS protocol. $_SERVER['HTTPS']='on'; } If you&rsquo;re getting desperate:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.mykro.co.nz/posts/"},{"@type":"ListItem","position":2,"name":"Nginx, Varnish and Wordpress with SSL Termination","item":"https://blog.mykro.co.nz/posts/2020-07-06-nginx-varnish-wordpress-ssl-termination/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nginx, Varnish and Wordpress with SSL Termination","name":"Nginx, Varnish and Wordpress with SSL Termination","description":"TL;DR Assuming you\u0026rsquo;ve already got your reverse proxy running, in wp-config.php add the following:\n1 2 3 4 5 6 7 8 9 \u0026lt;?php /** TLS/HTTPS fixes **/ // in some setups HTTP_X_FORWARDED_PROTO might contain a comma-separated list // e.g. http,https so check for https existence. if (strpos($_SERVER[\u0026#39;HTTP_X_FORWARDED_PROTO\u0026#39;], \u0026#39;https\u0026#39;) !== false) { // update HTTPS server variable to always \u0026#39;pretend\u0026#39; incoming requests were // performed via the HTTPS protocol. $_SERVER[\u0026#39;HTTPS\u0026#39;]=\u0026#39;on\u0026#39;; } If you\u0026rsquo;re getting desperate:","keywords":["DevOps","Nginx","WordPress","Varnish"],"articleBody":"TL;DR Assuming you’ve already got your reverse proxy running, in wp-config.php add the following:\n1 2 3 4 5 6 7 8 9 \u003c?php /** TLS/HTTPS fixes **/ // in some setups HTTP_X_FORWARDED_PROTO might contain a comma-separated list // e.g. http,https so check for https existence. if (strpos($_SERVER['HTTP_X_FORWARDED_PROTO'], 'https') !== false) { // update HTTPS server variable to always 'pretend' incoming requests were // performed via the HTTPS protocol. $_SERVER['HTTPS']='on'; } If you’re getting desperate:\n1 2 3 4 5 6 7 // If you ever get stuck, you can override the database set site URIs as well. define( 'WP_HOME', 'https://example.com' ); define( 'WP_SITEURL', 'https://example.com' ); // FORCE_SSL_ADMIN is for when you want to secure logins and the admin area so // that both passwords and cookies are never sent in the clear. define( 'FORCE_SSL_ADMIN', true ); Introduction If you are using a reverse proxy that performs SSL termination for you, you may find yourself in a redirect loop or getting a lot of mixed content as Wordpress, quite rightly, acts as if it’s a normal HTTP request.\nPHP uses server variables[1] that scripts can hook into to learn about their world. One of these magic variables, $_SERVER['HTTPS'], is set to a non-empty value if the script was queried through the HTTPS protocol.\nWordpress uses this variable ($_SERVER['HTTPS']) to detect if an incoming request should mutate links, hence leading to a nasty redirect loop when behind a reverse proxy with SSL termination.\n⚠️ Warning! There are a lot of example configuration files ahead!\nArchitecture Overview In order to fix it, we can programmatically make use of that standardised X-Forwarded-Proto header that can be forwarded via a proxy pass configuration in nginx, so we need to configure a few things. In this configuration we have the following architecture:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 +---------------------------+ | | | +-----------+ | | | Varnish | | | +--^----+---+ | | | | | +---------------+ | | | | | Client | | +--+----v-+ | | +--------\u003e| Nginx | | | (ノಠ ∩ಠ)ノ彡 | | +-------+-+ | +---------------+ | | | | | | | +--------v----+ | | | Wordpress | | | +-------------+ | | | | (づ｡◕‿‿◕｡)づ server | | | +---------------------------+ client -\u003e Nginx (https) -\u003e Varnish --(on cache miss)--\u003e Nginx (http) -\u003e wordpress client -\u003e Nginx (https) -\u003e Varnish (on cache hit) nginx (https) -\u003e varnish configuration This configures the client-\u003evarnish flow using SSL termination, but setting a number of X-Forwarded-* headers that we can use to pick up on.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // /etc/nginx/conf.d/example.com.https.conf # nginx (TLS termination) -\u003e varnish cache server { listen 443 ssl; listen [::]:443 ssl; ## Your website name goes here e.g. example.com *.example.com server_name example.com; server_name_in_redirect off; port_in_redirect off; ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem; include /etc/letsencrypt/options-ssl-nginx.conf; ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; location / { proxy_pass http://varnish; proxy_set_header Host $http_host; proxy_set_header HTTPS \"on\"; proxy_set_header X-Forwarded-Host $http_host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto https; proxy_set_header X-Forwarded-Port 443; proxy_set_header X-Real-IP $remote_addr; } } upstream varnish { server varnish:80; } varnish -\u003e nginx (http) configuration Thanks to Linode[2] for the reference implementation (which has been extended to add a X-Cache header for tracking cache hits).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 // default.vcl vcl 4.0; sub vcl_hit { set req.http.X-Cache = \"hit\"; } sub vcl_miss { set req.http.X-Cache = \"miss\"; } sub vcl_pass { set req.http.X-Cache = \"pass\"; } sub vcl_pipe { set req.http.X-Cache = \"pipe uncacheable\"; } // Specify that the backend (nginx) is listening on port 8080. // This is our internal backend route to wordpress. backend default { .host = \"nginx\"; .port = \"8080\"; } // Allow cache-purging requests only from the following hosts. acl purger { \"localhost\"; \"127.0.0.1\"; } sub vcl_recv { unset req.http.X-Cache; // Allow cache-purging requests only from the IP addresses in the above acl purger. // If a purge request comes from a different IP address, an error message will be produced. if (req.method == \"PURGE\") { if (!client.ip ~ purger) { return(synth(405, \"This IP is not allowed to send PURGE requests.\")); } return (purge); } // Change the X-Forwarded-For header if (req.restarts == 0) { if (req.http.X-Forwarded-For) { set req.http.X-Forwarded-For = client.ip; } } // Exclude POST requests or those with basic authentication from caching if (req.http.Authorization || req.method == \"POST\") { return (pass); } // Exclude RSS feeds from caching if (req.url ~ \"/feed\") { return (pass); } // Don't cache the WordPress admin and login pages: if (req.url ~ \"wp-admin|wp-login\") { return (pass); } // Remove has_js and CloudFlare/Google Analytics __* cookies and statcounter is_unique set req.http.Cookie = regsuball(req.http.Cookie, \"(^|;\\s*)(_[_a-z]+|has_js|is_unique)=[^;]*\", \"\"); // Remove a \";\" prefix, if present. set req.http.Cookie = regsub(req.http.Cookie, \"^;\\s*\", \"\"); // WordPress sets many cookies that are safe to ignore. set req.http.cookie = regsuball(req.http.cookie, \"wp-settings-\\d+=[^;]+(; )?\", \"\"); set req.http.cookie = regsuball(req.http.cookie, \"wp-settings-time-\\d+=[^;]+(; )?\", \"\"); set req.http.Cookie = regsuball(req.http.Cookie, \"wordpress_test_cookie=[^;]+(; )?\", \"\"); if (req.http.cookie == \"\") { unset req.http.cookie; } } // Cache-purging for a particular page must occur each time we make edits // to that page. sub vcl_purge { set req.method = \"GET\"; set req.http.X-Purger = \"Purged\"; return (restart); } // The sub vcl_backend_response directive is used to handle communication // with the backend server, nginx. We use it to set the amount of time // the content remains in the cache. // We can also set a grace period, which determines how Varnish will serve // content from the cache even if the backend server is down. // - Time can be set in seconds (s), minutes (m), hours (h) or days (d). // Here, we’ve set the caching time to 24 hours, and the grace period to // 1 hour, but you can adjust these settings based on your needs. sub vcl_backend_response { set beresp.ttl = 24h; set beresp.grace = 1h; if (bereq.url !~ \"wp-admin|wp-login|product|cart|checkout|my-account|/?remove_item=\") { unset beresp.http.set-cookie; } } // Change the headers for purge requests. sub vcl_deliver { if (req.http.X-Purger) { set resp.http.X-Purger = req.http.X-Purger; } if (obj.uncacheable) { set req.http.X-Cache = req.http.X-Cache + \" uncacheable\" ; } else { set req.http.X-Cache = req.http.X-Cache + \" cached\" ; } // set X-Cache header in response set resp.http.X-Cache = req.http.X-Cache; } nginx (http) -\u003e wordpress configuration Here we use a generic nginx+php-fpm fastcgi_pass configuration.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 // /etc/nginx/conf.d/example.com.http.conf # nginx (TLS termination) -\u003e varnish cache -\u003e nginx http -\u003e php-fpm server { listen 8080; listen [::]:8080; server_name example.com; server_name_in_redirect off; port_in_redirect off; access_log /var/log/nginx/example.com/access.log; error_log /var/log/nginx/example.com/error.log info; ## Your only path reference. root /var/www/example.com; location = /favicon.ico { log_not_found off; access_log off; } location = /robots.txt { allow all; log_not_found off; access_log off; } # deny running scripts inside writable directories location ~* /(images|cache|media|logs|tmp)/.*\\.(php|pl|py|jsp|asp|sh|cgi)$ { return 403; error_page 403 /403_error.html; } location / { # This is cool because no php is touched for static content. # include the \"?$args\" part so non-default permalinks doesn't break when using query string try_files $uri $uri/ /index.php?$is_args$query_string; } location ~ \\.php$ { try_files $uri =404; fastcgi_split_path_info ^(.+\\.php)(/.+)$; fastcgi_intercept_errors on; #NOTE: You should have \"cgi.fix_pathinfo = 0;\" in php.ini include /etc/nginx/fastcgi.conf; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_pass php-fpm; } location ~* \\.(js|css|png|jpg|jpeg|gif|ico)$ { expires max; log_not_found off; } } upstream php-fpm { server php-fpm:9000; } Forcing ‘Faux’TTPS for PHP (wp-config.php configuration) Woo! Now we have all the above bootstrapped, we can finally grab the X-Forwarded-Proto header that’s been passed along, and force PHP to think that $_SERVER['HTTPS'] = 'on'; by creating an override in wp-config.php[3]\n1 2 3 4 5 6 7 8 9 10 // wp-config.php \u003c?php /** TLS/HTTPS fixes **/ // in some setups HTTP_X_FORWARDED_PROTO might contain a comma-separated list // e.g. http,https so check for https existence. if (strpos($_SERVER['HTTP_X_FORWARDED_PROTO'], 'https') !== false) { // update HTTPS server variable to always 'pretend' incoming requests were // performed via the HTTPS protocol. $_SERVER['HTTPS']='on'; } If you get stuck, or redirects are still happening, you can use the site variables to revert to HTTP, or enforce an HTTPS root uri, which will override the database configuration:\n1 2 3 4 5 // wp-config.php // If you ever get stuck, you can override the database set site URIs as well. define( 'WP_HOME', 'https://example.com' ); define( 'WP_SITEURL', 'https://example.com' ); Lastly, you can enforce that admin must be visited over HTTPS (FauxTTPS?) by setting FORCE_SSL_ADMIN[4] to stop bad actors trying to jump in over HTTP… ¯\\_(ツ)_/¯\n1 2 3 4 5 // wp-config.php // FORCE_SSL_ADMIN is for when you want to secure logins and the admin area so // that both passwords and cookies are never sent in the clear. define( 'FORCE_SSL_ADMIN', true ); Addendum ASCII chart created by: asciiflow Time to SSL Termination frustration: 7+ hours Time to Blog: 1h:39m ","wordCount":"1650","inLanguage":"en","image":"https://blog.mykro.co.nz/images/wordpress-ssl.jpeg","datePublished":"2020-07-06T22:13:09+12:00","dateModified":"2020-07-06T22:13:09+12:00","author":{"@type":"Person","name":"Matthew Hartstonge"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.mykro.co.nz/posts/2020-07-06-nginx-varnish-wordpress-ssl-termination/"},"publisher":{"@type":"Organization","name":"Matthew Hartstonge","logo":{"@type":"ImageObject","url":"https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=250"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.mykro.co.nz/ accesskey=h title="Matthew Hartstonge (Alt + H)">Matthew Hartstonge</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.mykro.co.nz/posts title=Blog><span>Blog</span></a></li><li><a href=https://blog.mykro.co.nz/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.mykro.co.nz/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Nginx, Varnish and Wordpress with SSL Termination</h1><div class=post-meta><span title='2020-07-06 22:13:09 +1200 NZST'>July 6, 2020</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1650 words&nbsp;·&nbsp;Matthew Hartstonge</div></header><figure class=entry-cover><img loading=eager src=https://blog.mykro.co.nz/images/wordpress-ssl.jpeg alt="A writer sits at a table with a pencil drawing art with an abstract background containing security iconography"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#architecture-overview>Architecture Overview</a><ul><li><a href=#nginx-https---varnish-configuration>nginx (https) -> varnish configuration</a></li><li><a href=#varnish---nginx-http-configuration>varnish -> nginx (http) configuration</a></li><li><a href=#nginx-http---wordpress-configuration>nginx (http) -> wordpress configuration</a></li></ul></li><li><a href=#forcing-fauxttps-for-php-wp-configphp-configuration>Forcing &lsquo;Faux&rsquo;TTPS for PHP (wp-config.php configuration)</a></li><li><a href=#addendum>Addendum</a></li></ul></nav></div></details></div><div class=post-content><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>Assuming you&rsquo;ve already got your reverse proxy running, in <code>wp-config.php</code> add
the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=sd>/** TLS/HTTPS fixes **/</span>
</span></span><span class=line><span class=cl><span class=c1>// in some setups HTTP_X_FORWARDED_PROTO might contain a comma-separated list
</span></span></span><span class=line><span class=cl><span class=c1>// e.g. http,https so check for https existence.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_X_FORWARDED_PROTO&#39;</span><span class=p>],</span> <span class=s1>&#39;https&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// update HTTPS server variable to always &#39;pretend&#39; incoming requests were 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// performed via the HTTPS protocol.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTPS&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;on&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>If you&rsquo;re getting desperate:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// If you ever get stuck, you can override the database set site URIs as well.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>define</span><span class=p>(</span> <span class=s1>&#39;WP_HOME&#39;</span><span class=p>,</span>    <span class=s1>&#39;https://example.com&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span> <span class=s1>&#39;WP_SITEURL&#39;</span><span class=p>,</span> <span class=s1>&#39;https://example.com&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// FORCE_SSL_ADMIN is for when you want to secure logins and the admin area so
</span></span></span><span class=line><span class=cl><span class=c1>// that both passwords and cookies are never sent in the clear.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>define</span><span class=p>(</span> <span class=s1>&#39;FORCE_SSL_ADMIN&#39;</span><span class=p>,</span> <span class=k>true</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>If you are using a reverse proxy that performs SSL termination for you, you may
find yourself in a redirect loop or getting a lot of mixed content as Wordpress,
quite rightly, acts as if it&rsquo;s a normal HTTP request.</p><p>PHP uses server variables<a href=#php-server-vars>[1]</a> that scripts
can hook into to learn about their world. One of these magic variables,
<code>$_SERVER['HTTPS']</code>, is set to a non-empty value if the script was queried
through the HTTPS protocol.</p><p>Wordpress uses this variable (<code>$_SERVER['HTTPS']</code>) to detect if an incoming
request should mutate links, hence leading to a nasty redirect loop when behind
a reverse proxy with SSL termination.</p><p>&#9888;&#xfe0f; Warning! There are a lot of example configuration files ahead!</p><h2 id=architecture-overview>Architecture Overview<a hidden class=anchor aria-hidden=true href=#architecture-overview>#</a></h2><p>In order to fix it, we can programmatically make use of that standardised
<code>X-Forwarded-Proto</code> header that can be forwarded via a proxy pass configuration
in nginx, so we need to configure a few things. In this configuration we have
the following architecture:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>                                +---------------------------+
</span></span><span class=line><span class=cl>                                |                           |
</span></span><span class=line><span class=cl>                                |     +-----------+         |
</span></span><span class=line><span class=cl>                                |     |  Varnish  |         |
</span></span><span class=line><span class=cl>                                |     +--^----+---+         |
</span></span><span class=line><span class=cl>                                |        |    |             |
</span></span><span class=line><span class=cl>            +---------------+   |        |    |             |
</span></span><span class=line><span class=cl>            |    Client     |   |     +--+----v-+           |
</span></span><span class=line><span class=cl>            |               +--------&gt;|  Nginx  |           |
</span></span><span class=line><span class=cl>            |  (ノಠ ∩ಠ)ノ彡 |   |     +-------+-+           |
</span></span><span class=line><span class=cl>            +---------------+   |             |             |
</span></span><span class=line><span class=cl>                                |             |             |
</span></span><span class=line><span class=cl>                                |    +--------v----+        |
</span></span><span class=line><span class=cl>                                |    |  Wordpress  |        |
</span></span><span class=line><span class=cl>                                |    +-------------+        |
</span></span><span class=line><span class=cl>                                |                           |
</span></span><span class=line><span class=cl>                                |   (づ｡◕‿‿◕｡)づ server   |
</span></span><span class=line><span class=cl>                                |                           |
</span></span><span class=line><span class=cl>                                +---------------------------+
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     client -&gt; Nginx (https) -&gt; Varnish --(on cache miss)--&gt; Nginx (http) -&gt; wordpress
</span></span><span class=line><span class=cl>                    client -&gt; Nginx (https) -&gt; Varnish (on cache hit)
</span></span></code></pre></td></tr></table></div></div><h3 id=nginx-https---varnish-configuration>nginx (https) -> varnish configuration<a hidden class=anchor aria-hidden=true href=#nginx-https---varnish-configuration>#</a></h3><p>This configures the client->varnish flow using SSL termination, but setting a
number of <code>X-Forwarded-*</code> headers that we can use to pick up on.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>conf</span><span class=o>.</span><span class=n>d</span><span class=o>/</span><span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=o>.</span><span class=n>https</span><span class=o>.</span><span class=n>conf</span>
</span></span><span class=line><span class=cl><span class=c1># nginx (TLS termination) -&gt; varnish cache</span>
</span></span><span class=line><span class=cl><span class=n>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listen</span> <span class=mi>443</span> <span class=n>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>listen</span> <span class=p>[::]:</span><span class=mi>443</span> <span class=n>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>## Your website name goes here e.g. example.com *.example.com</span>
</span></span><span class=line><span class=cl>    <span class=n>server_name</span> <span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>server_name_in_redirect</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>port_in_redirect</span>        <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ssl_certificate</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>letsencrypt</span><span class=o>/</span><span class=n>live</span><span class=o>/</span><span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>fullchain</span><span class=o>.</span><span class=n>pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ssl_certificate_key</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>letsencrypt</span><span class=o>/</span><span class=n>live</span><span class=o>/</span><span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>privkey</span><span class=o>.</span><span class=n>pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>include</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>letsencrypt</span><span class=o>/</span><span class=n>options</span><span class=o>-</span><span class=n>ssl</span><span class=o>-</span><span class=n>nginx</span><span class=o>.</span><span class=n>conf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ssl_dhparam</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>letsencrypt</span><span class=o>/</span><span class=n>ssl</span><span class=o>-</span><span class=n>dhparams</span><span class=o>.</span><span class=n>pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>location</span> <span class=o>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_pass</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>varnish</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>proxy_set_header</span> <span class=n>Host</span> <span class=o>$</span><span class=n>http_host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_set_header</span> <span class=n>HTTPS</span> <span class=s2>&#34;on&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_set_header</span> <span class=n>X</span><span class=o>-</span><span class=n>Forwarded</span><span class=o>-</span><span class=n>Host</span> <span class=o>$</span><span class=n>http_host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_set_header</span> <span class=n>X</span><span class=o>-</span><span class=n>Forwarded</span><span class=o>-</span><span class=n>For</span> <span class=o>$</span><span class=n>proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_set_header</span> <span class=n>X</span><span class=o>-</span><span class=n>Forwarded</span><span class=o>-</span><span class=n>Proto</span> <span class=n>https</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_set_header</span> <span class=n>X</span><span class=o>-</span><span class=n>Forwarded</span><span class=o>-</span><span class=n>Port</span> <span class=mi>443</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_set_header</span> <span class=n>X</span><span class=o>-</span><span class=n>Real</span><span class=o>-</span><span class=ne>IP</span> <span class=o>$</span><span class=n>remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>upstream</span> <span class=n>varnish</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=n>varnish</span><span class=p>:</span><span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=varnish---nginx-http-configuration>varnish -> nginx (http) configuration<a hidden class=anchor aria-hidden=true href=#varnish---nginx-http-configuration>#</a></h3><p>Thanks to Linode<a href=#linode-varnish-wordpress>[2]</a> for the
reference implementation (which has been extended to add a <code>X-Cache</code> header for
tracking cache hits).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// default.vcl
</span></span><span class=line><span class=cl>vcl 4.0;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sub vcl_hit {
</span></span><span class=line><span class=cl>    set req.http.X-Cache = &#34;hit&#34;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sub vcl_miss {
</span></span><span class=line><span class=cl>    set req.http.X-Cache = &#34;miss&#34;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sub vcl_pass {
</span></span><span class=line><span class=cl>    set req.http.X-Cache = &#34;pass&#34;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sub vcl_pipe {
</span></span><span class=line><span class=cl>    set req.http.X-Cache = &#34;pipe uncacheable&#34;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Specify that the backend (nginx) is listening on port 8080.
</span></span><span class=line><span class=cl>// This is our internal backend route to wordpress.
</span></span><span class=line><span class=cl>backend default {
</span></span><span class=line><span class=cl>  .host = &#34;nginx&#34;;
</span></span><span class=line><span class=cl>  .port = &#34;8080&#34;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Allow cache-purging requests only from the following hosts.
</span></span><span class=line><span class=cl>acl purger {
</span></span><span class=line><span class=cl>  &#34;localhost&#34;;
</span></span><span class=line><span class=cl>  &#34;127.0.0.1&#34;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sub vcl_recv {
</span></span><span class=line><span class=cl>    unset req.http.X-Cache;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Allow cache-purging requests only from the IP addresses in the above acl purger.
</span></span><span class=line><span class=cl>    // If a purge request comes from a different IP address, an error message will be produced.
</span></span><span class=line><span class=cl>    if (req.method == &#34;PURGE&#34;) {
</span></span><span class=line><span class=cl>        if (!client.ip ~ purger) {
</span></span><span class=line><span class=cl>            return(synth(405, &#34;This IP is not allowed to send PURGE requests.&#34;));
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        return (purge);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Change the X-Forwarded-For header
</span></span><span class=line><span class=cl>    if (req.restarts == 0) {
</span></span><span class=line><span class=cl>        if (req.http.X-Forwarded-For) {
</span></span><span class=line><span class=cl>            set req.http.X-Forwarded-For = client.ip;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Exclude POST requests or those with basic authentication from caching
</span></span><span class=line><span class=cl>    if (req.http.Authorization || req.method == &#34;POST&#34;) {
</span></span><span class=line><span class=cl>        return (pass);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Exclude RSS feeds from caching
</span></span><span class=line><span class=cl>    if (req.url ~ &#34;/feed&#34;) {
</span></span><span class=line><span class=cl>        return (pass);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Don&#39;t cache the WordPress admin and login pages:
</span></span><span class=line><span class=cl>    if (req.url ~ &#34;wp-admin|wp-login&#34;) {
</span></span><span class=line><span class=cl>        return (pass);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Remove has_js and CloudFlare/Google Analytics __* cookies and statcounter is_unique
</span></span><span class=line><span class=cl>    set req.http.Cookie = regsuball(req.http.Cookie, &#34;(^|;\s*)(_[_a-z]+|has_js|is_unique)=[^;]*&#34;, &#34;&#34;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Remove a &#34;;&#34; prefix, if present.
</span></span><span class=line><span class=cl>    set req.http.Cookie = regsub(req.http.Cookie, &#34;^;\s*&#34;, &#34;&#34;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // WordPress sets many cookies that are safe to ignore.
</span></span><span class=line><span class=cl>    set req.http.cookie = regsuball(req.http.cookie, &#34;wp-settings-\d+=[^;]+(; )?&#34;, &#34;&#34;);
</span></span><span class=line><span class=cl>    set req.http.cookie = regsuball(req.http.cookie, &#34;wp-settings-time-\d+=[^;]+(; )?&#34;, &#34;&#34;);
</span></span><span class=line><span class=cl>    set req.http.Cookie = regsuball(req.http.Cookie, &#34;wordpress_test_cookie=[^;]+(; )?&#34;, &#34;&#34;);
</span></span><span class=line><span class=cl>    if (req.http.cookie == &#34;&#34;) {
</span></span><span class=line><span class=cl>        unset req.http.cookie;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Cache-purging for a particular page must occur each time we make edits
</span></span><span class=line><span class=cl>// to that page.
</span></span><span class=line><span class=cl>sub vcl_purge {
</span></span><span class=line><span class=cl>    set req.method = &#34;GET&#34;;
</span></span><span class=line><span class=cl>    set req.http.X-Purger = &#34;Purged&#34;;
</span></span><span class=line><span class=cl>    return (restart);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// The sub vcl_backend_response directive is used to handle communication
</span></span><span class=line><span class=cl>// with the backend server, nginx. We use it to set the amount of time
</span></span><span class=line><span class=cl>// the content remains in the cache.
</span></span><span class=line><span class=cl>// We can also set a grace period, which determines how Varnish will serve
</span></span><span class=line><span class=cl>// content from the cache even if the backend server is down.
</span></span><span class=line><span class=cl>// - Time can be set in seconds (s), minutes (m), hours (h) or days (d).
</span></span><span class=line><span class=cl>// Here, we’ve set the caching time to 24 hours, and the grace period to
</span></span><span class=line><span class=cl>// 1 hour, but you can adjust these settings based on your needs.
</span></span><span class=line><span class=cl>sub vcl_backend_response {
</span></span><span class=line><span class=cl>    set beresp.ttl = 24h;
</span></span><span class=line><span class=cl>    set beresp.grace = 1h;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (bereq.url !~ &#34;wp-admin|wp-login|product|cart|checkout|my-account|/?remove_item=&#34;) {
</span></span><span class=line><span class=cl>        unset beresp.http.set-cookie;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Change the headers for purge requests.
</span></span><span class=line><span class=cl>sub vcl_deliver {
</span></span><span class=line><span class=cl>    if (req.http.X-Purger) {
</span></span><span class=line><span class=cl>        set resp.http.X-Purger = req.http.X-Purger;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (obj.uncacheable) {
</span></span><span class=line><span class=cl>        set req.http.X-Cache = req.http.X-Cache + &#34; uncacheable&#34; ;
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        set req.http.X-Cache = req.http.X-Cache + &#34; cached&#34; ;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // set X-Cache header in response
</span></span><span class=line><span class=cl>    set resp.http.X-Cache = req.http.X-Cache;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=nginx-http---wordpress-configuration>nginx (http) -> wordpress configuration<a hidden class=anchor aria-hidden=true href=#nginx-http---wordpress-configuration>#</a></h3><p>Here we use a generic nginx+php-fpm fastcgi_pass configuration.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>conf</span><span class=o>.</span><span class=n>d</span><span class=o>/</span><span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=o>.</span><span class=n>http</span><span class=o>.</span><span class=n>conf</span>
</span></span><span class=line><span class=cl><span class=c1># nginx (TLS termination) -&gt; varnish cache -&gt; nginx http -&gt; php-fpm</span>
</span></span><span class=line><span class=cl><span class=n>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>listen</span> <span class=mi>8080</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>listen</span> <span class=p>[::]:</span><span class=mi>8080</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>server_name</span> <span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>server_name_in_redirect</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>port_in_redirect</span>        <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>access_log</span>  <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=nb>log</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>access</span><span class=o>.</span><span class=n>log</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>error_log</span>   <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=nb>log</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>error</span><span class=o>.</span><span class=n>log</span> <span class=n>info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>## Your only path reference.</span>
</span></span><span class=line><span class=cl>    <span class=n>root</span>        <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>example</span><span class=o>.</span><span class=n>com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>location</span> <span class=o>=</span> <span class=o>/</span><span class=n>favicon</span><span class=o>.</span><span class=n>ico</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log_not_found</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>access_log</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>location</span> <span class=o>=</span> <span class=o>/</span><span class=n>robots</span><span class=o>.</span><span class=n>txt</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>allow</span> <span class=n>all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>log_not_found</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>access_log</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># deny running scripts inside writable directories</span>
</span></span><span class=line><span class=cl>    <span class=n>location</span> <span class=o>~*</span> <span class=o>/</span><span class=p>(</span><span class=n>images</span><span class=o>|</span><span class=n>cache</span><span class=o>|</span><span class=n>media</span><span class=o>|</span><span class=n>logs</span><span class=o>|</span><span class=n>tmp</span><span class=p>)</span><span class=o>/.*</span>\<span class=o>.</span><span class=p>(</span><span class=n>php</span><span class=o>|</span><span class=n>pl</span><span class=o>|</span><span class=n>py</span><span class=o>|</span><span class=n>jsp</span><span class=o>|</span><span class=n>asp</span><span class=o>|</span><span class=n>sh</span><span class=o>|</span><span class=n>cgi</span><span class=p>)</span><span class=o>$</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>          <span class=mi>403</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>error_page</span>      <span class=mi>403</span> <span class=o>/</span><span class=mi>403</span><span class=n>_error</span><span class=o>.</span><span class=n>html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>location</span> <span class=o>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1># This is cool because no php is touched for static content.</span>
</span></span><span class=line><span class=cl>        <span class=c1># include the &#34;?$args&#34; part so non-default permalinks doesn&#39;t break when using query string</span>
</span></span><span class=line><span class=cl>        <span class=n>try_files</span> <span class=o>$</span><span class=n>uri</span> <span class=o>$</span><span class=n>uri</span><span class=o>/</span> <span class=o>/</span><span class=n>index</span><span class=o>.</span><span class=n>php</span><span class=err>?</span><span class=o>$</span><span class=n>is_args</span><span class=o>$</span><span class=n>query_string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>location</span> <span class=o>~</span> \<span class=o>.</span><span class=n>php</span><span class=o>$</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>try_files</span>                   <span class=o>$</span><span class=n>uri</span> <span class=o>=</span><span class=mi>404</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>fastcgi_split_path_info</span>     <span class=o>^</span><span class=p>(</span><span class=o>.+</span>\<span class=o>.</span><span class=n>php</span><span class=p>)(</span><span class=o>/.+</span><span class=p>)</span><span class=o>$</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>fastcgi_intercept_errors</span>    <span class=n>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>#NOTE: You should have &#34;cgi.fix_pathinfo = 0;&#34; in php.ini</span>
</span></span><span class=line><span class=cl>        <span class=n>include</span>         <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>nginx</span><span class=o>/</span><span class=n>fastcgi</span><span class=o>.</span><span class=n>conf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>fastcgi_index</span>   <span class=n>index</span><span class=o>.</span><span class=n>php</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>fastcgi_param</span>   <span class=n>SCRIPT_FILENAME</span>     <span class=o>$</span><span class=n>document_root</span><span class=o>$</span><span class=n>fastcgi_script_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>fastcgi_pass</span>    <span class=n>php</span><span class=o>-</span><span class=n>fpm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>location</span> <span class=o>~*</span> \<span class=o>.</span><span class=p>(</span><span class=n>js</span><span class=o>|</span><span class=n>css</span><span class=o>|</span><span class=n>png</span><span class=o>|</span><span class=n>jpg</span><span class=o>|</span><span class=n>jpeg</span><span class=o>|</span><span class=n>gif</span><span class=o>|</span><span class=n>ico</span><span class=p>)</span><span class=o>$</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>expires</span> <span class=nb>max</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>log_not_found</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>upstream</span> <span class=n>php</span><span class=o>-</span><span class=n>fpm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=n>php</span><span class=o>-</span><span class=n>fpm</span><span class=p>:</span><span class=mi>9000</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=forcing-fauxttps-for-php-wp-configphp-configuration>Forcing &lsquo;Faux&rsquo;TTPS for PHP (wp-config.php configuration)<a hidden class=anchor aria-hidden=true href=#forcing-fauxttps-for-php-wp-configphp-configuration>#</a></h2><p>Woo! Now we have all the above bootstrapped, we can finally grab the
<code>X-Forwarded-Proto</code> header that&rsquo;s been passed along, and force PHP to think that
<code>$_SERVER['HTTPS'] = 'on';</code> by creating an override in <code>wp-config.php</code><a href=#using-reverse-proxy>[3]</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// wp-config.php
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=sd>/** TLS/HTTPS fixes **/</span>
</span></span><span class=line><span class=cl><span class=c1>// in some setups HTTP_X_FORWARDED_PROTO might contain a comma-separated list
</span></span></span><span class=line><span class=cl><span class=c1>// e.g. http,https so check for https existence.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nx>strpos</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_X_FORWARDED_PROTO&#39;</span><span class=p>],</span> <span class=s1>&#39;https&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// update HTTPS server variable to always &#39;pretend&#39; incoming requests were 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// performed via the HTTPS protocol.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTPS&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;on&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>If you get stuck, or redirects are still happening, you can use the site
variables to revert to HTTP, or enforce an HTTPS root uri, which will override
the database configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// wp-config.php
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// If you ever get stuck, you can override the database set site URIs as well.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>define</span><span class=p>(</span> <span class=s1>&#39;WP_HOME&#39;</span><span class=p>,</span>    <span class=s1>&#39;https://example.com&#39;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span> <span class=s1>&#39;WP_SITEURL&#39;</span><span class=p>,</span> <span class=s1>&#39;https://example.com&#39;</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Lastly, you can enforce that admin must be visited over HTTPS (FauxTTPS?) by
setting <code>FORCE_SSL_ADMIN</code><a href=#force-admin-ssl>[4]</a> to stop bad
actors trying to jump in over HTTP&mldr; <code>¯\_(ツ)_/¯</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=c1>// wp-config.php
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// FORCE_SSL_ADMIN is for when you want to secure logins and the admin area so
</span></span></span><span class=line><span class=cl><span class=c1>// that both passwords and cookies are never sent in the clear.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>define</span><span class=p>(</span> <span class=s1>&#39;FORCE_SSL_ADMIN&#39;</span><span class=p>,</span> <span class=k>true</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=addendum>Addendum<a hidden class=anchor aria-hidden=true href=#addendum>#</a></h2><ul><li>ASCII chart created by: <a href=http://asciiflow.com/>asciiflow</a></li><li>Time to SSL Termination frustration: 7+ hours</li><li>Time to Blog: 1h:39m</li></ul></div><h2>References</h2><ol><li id=php-server-vars>The PHP Group. (n.d.) <i>"PHP: $_SERVER - Manual."</i> Retrieved July 06, 2020, from <a rel=noopener target=_blank href=https://www.php.net/manual/en/reserved.variables.server.php>https://www.php.net/manual/en/reserved.variables.server.php</a>.</li><li id=linode-varnish-wordpress>Linode. (2019-11-07) <i>"Use Varnish & NGINX to Serve WordPress over SSL & HTTP on Debian 8."</i> Retrieved July 06, 2020, from <a rel=noopener target=_blank href=https://www.linode.com/docs/websites/varnish/use-varnish-and-nginx-to-serve-wordpress-over-ssl-and-http-on-debian-8/>https://www.linode.com/docs/websites/varnish/use-varnish-and-nginx-to-serve-wordpress-over-ssl-and-http-on-debian-8/</a>.</li><li id=using-reverse-proxy>Wordpress. (n.d.) <i>"Administration Over SSL (using a reverse proxy)."</i> Retrieved July 06, 2020, from <a rel=noopener target=_blank href=https://wordpress.org/support/article/administration-over-ssl/#using-a-reverse-proxy>https://wordpress.org/support/article/administration-over-ssl/#using-a-reverse-proxy</a>.</li><li id=force-admin-ssl>Wordpress. (n.d.) <i>"Administration Over SSL (force ssl logins and ssl admin access)."</i> Retrieved July 06, 2020, from <a rel=noopener target=_blank href=https://wordpress.org/support/article/administration-over-ssl/#to-force-ssl-logins-and-ssl-admin-access>https://wordpress.org/support/article/administration-over-ssl/#to-force-ssl-logins-and-ssl-admin-access</a>.</li></ol><footer class=post-footer><ul class=post-tags><li><a href=https://blog.mykro.co.nz/tags/devops/>DevOps</a></li><li><a href=https://blog.mykro.co.nz/tags/nginx/>Nginx</a></li><li><a href=https://blog.mykro.co.nz/tags/wordpress/>WordPress</a></li><li><a href=https://blog.mykro.co.nz/tags/varnish/>Varnish</a></li></ul></footer></article></main><footer class=footer><span>© Copyright 2024 Matthew Hartstonge</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>