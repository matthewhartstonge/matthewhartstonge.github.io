<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Devlog: 001 - Building Terraform Providers | Matthew Hartstonge</title>
<meta name=keywords content="DevOps,Go,Golang,Programming,SoftwareDevelopment,SoftwareEngineering,Terraform,PluginFramework,Provider"><meta name=description content="Terraform If you&rsquo;ve been living under a rock or happen to be a newcomer in the DevOps/Site Reliability Engineering space, Hashicorp&rsquo;s Terraform enables provisioning and managing cloud infrastructure. It&rsquo;s essentially a glorified diffing tool for any cloud resource that, as long as a Terraform Provider exists, can ensure the state of your infrastructure is as expected when written in Hashicorp Config Language (HCL).
As a forewarning before digging deeper, it has been common to hear some Linuxy sysadmin-looking neckbeards in-passing talking about infrastructure as code, better known as IaC, being the bee&rsquo;s knees and how they keep managing to give Dave a good ribbing after causing the Great Network failure of &lsquo;22 after performing a Git force push&mldr;"><meta name=author content="Matthew Hartstonge"><link rel=canonical href=https://blog.mykro.co.nz/posts/2023-07-12-devlog-001/><meta name=google-site-verification content="G-3N8ZQ0TS42"><link crossorigin=anonymous href=/assets/css/stylesheet.49e1a9d11d71e94986513bdf8be953c1be6edeee520b367d13aa6b887bafe4f5.css integrity="sha256-SeGp0R1x6UmGUTvfi+lTwb5u3u5SCzZ9E6priHuv5PU=" rel="preload stylesheet" as=style><link rel=icon href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=250"><link rel=icon type=image/png sizes=16x16 href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=16"><link rel=icon type=image/png sizes=32x32 href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=32"><link rel=apple-touch-icon href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=192"><link rel=mask-icon href="https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=64"><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.mykro.co.nz/posts/2023-07-12-devlog-001/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Devlog: 001 - Building Terraform Providers"><meta property="og:description" content="Terraform If you&rsquo;ve been living under a rock or happen to be a newcomer in the DevOps/Site Reliability Engineering space, Hashicorp&rsquo;s Terraform enables provisioning and managing cloud infrastructure. It&rsquo;s essentially a glorified diffing tool for any cloud resource that, as long as a Terraform Provider exists, can ensure the state of your infrastructure is as expected when written in Hashicorp Config Language (HCL).
As a forewarning before digging deeper, it has been common to hear some Linuxy sysadmin-looking neckbeards in-passing talking about infrastructure as code, better known as IaC, being the bee&rsquo;s knees and how they keep managing to give Dave a good ribbing after causing the Great Network failure of &lsquo;22 after performing a Git force push&mldr;"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.mykro.co.nz/posts/2023-07-12-devlog-001/"><meta property="og:image" content="https://blog.mykro.co.nz/images/developing-terraform-providers.jpeg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-12T21:59:45+12:00"><meta property="article:modified_time" content="2023-07-12T21:59:45+12:00"><meta property="og:site_name" content="Matthew Hartstonge"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.mykro.co.nz/images/developing-terraform-providers.jpeg"><meta name=twitter:title content="Devlog: 001 - Building Terraform Providers"><meta name=twitter:description content="Terraform If you&rsquo;ve been living under a rock or happen to be a newcomer in the DevOps/Site Reliability Engineering space, Hashicorp&rsquo;s Terraform enables provisioning and managing cloud infrastructure. It&rsquo;s essentially a glorified diffing tool for any cloud resource that, as long as a Terraform Provider exists, can ensure the state of your infrastructure is as expected when written in Hashicorp Config Language (HCL).
As a forewarning before digging deeper, it has been common to hear some Linuxy sysadmin-looking neckbeards in-passing talking about infrastructure as code, better known as IaC, being the bee&rsquo;s knees and how they keep managing to give Dave a good ribbing after causing the Great Network failure of &lsquo;22 after performing a Git force push&mldr;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.mykro.co.nz/posts/"},{"@type":"ListItem","position":2,"name":"Devlog: 001 - Building Terraform Providers","item":"https://blog.mykro.co.nz/posts/2023-07-12-devlog-001/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Devlog: 001 - Building Terraform Providers","name":"Devlog: 001 - Building Terraform Providers","description":"Terraform If you\u0026rsquo;ve been living under a rock or happen to be a newcomer in the DevOps/Site Reliability Engineering space, Hashicorp\u0026rsquo;s Terraform enables provisioning and managing cloud infrastructure. It\u0026rsquo;s essentially a glorified diffing tool for any cloud resource that, as long as a Terraform Provider exists, can ensure the state of your infrastructure is as expected when written in Hashicorp Config Language (HCL).\nAs a forewarning before digging deeper, it has been common to hear some Linuxy sysadmin-looking neckbeards in-passing talking about infrastructure as code, better known as IaC, being the bee\u0026rsquo;s knees and how they keep managing to give Dave a good ribbing after causing the Great Network failure of \u0026lsquo;22 after performing a Git force push\u0026hellip;","keywords":["DevOps","Go","Golang","Programming","SoftwareDevelopment","SoftwareEngineering","Terraform","PluginFramework","Provider"],"articleBody":"Terraform If you’ve been living under a rock or happen to be a newcomer in the DevOps/Site Reliability Engineering space, Hashicorp’s Terraform enables provisioning and managing cloud infrastructure. It’s essentially a glorified diffing tool for any cloud resource that, as long as a Terraform Provider exists, can ensure the state of your infrastructure is as expected when written in Hashicorp Config Language (HCL).\nAs a forewarning before digging deeper, it has been common to hear some Linuxy sysadmin-looking neckbeards in-passing talking about infrastructure as code, better known as IaC, being the bee’s knees and how they keep managing to give Dave a good ribbing after causing the Great Network failure of ‘22 after performing a Git force push…\nTerraform could be your new life.\nIt’s a good one.\nI digress…\nThe great thing about Terraform is that it provides for your infrastructure:\nAutomated creation of new resources Showing the difference between current and expected resources on terraform plan The ability to reconcile the current state with the written expectation on terraform apply And when used with Git, an auditable history of changes Plenty of Terraform Providers exist for cloud providers, for example, Azure, AWS, Digital Ocean and more! But while Terraform can manage Cloud Resources, it has been built so that, as long as you can interact with an API (create, read, update or delete) to adjust the state of a given “Thing”, it can be managed by Terraform.\nProviders Hashicorp has maintained a wonderfully extensible Terraform Plugin Software Development Kit (SDK) for creating Providers for many, many years and has recently journeyed into what it would look like to build an idiomatically Go, more streamlined, strongly typed framework with documentation generation for creating providers. If you want to dig into the weeds to understand the difference between the Plugin SDKv2 and the Plugin Framework, check out Hashicorp’s article on the “Plugin Framework Benefits”.\nObjectives At my place of employment, we have been using FusionAuth as our 3rd-party auth provider and a community-maintained Terraform Provider, which I have committed and pushed many a PR to. While it works, there are several rough edges that would be nice to round out, plus I wanted to gain an appreciation of where Hashicorp is heading with the new framework.\nMy main objectives when starting this project are:\nConsistency - Ensuring that the project has a similar consistent pattern of solving common problems. DX/UX - Ensure it provides a much better developer and user experience due to automatic documentation generation or better error suggestions. Testability - Ensuring that the project has proper acceptance tests that show when the API of FusionAuth or the Go-Client has broken the Terraform Provider. Starting Out Hashicorp kindly provides many good resources for creating your first Terraform Provider. The first thing I read through was Hashicorp’s documentation on Plugin Development. I then cloned the Terraform Provider Scaffolding Framework repo and proceeded to get myself versed in the repo’s layout.\nInterestingly, the Provider implementation is stored in an internal folder, meaning external developers can’t import the Provider code. Not a bad thing, but it helps to force developers to use the Terraform Provider as a gRPC binary plugin assuming they don’t want to copy+paste code.\nDelving into internal/provider/provider.go I started to build out my FusionAuth Provider config - enabling the configuration of a Host Name and API Token.\nAfter an initial skeleton, I backtracked to the docs and found a helpful walkthrough article on framework-based Providers. The info gleaned here helped with initial provider configuration - using envvars and pulling data out from the config struct was pertinent to success. So that was neat to find.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 func (p *FusionAuthProvider) Configure(ctx context.Context, req provider.ConfigureRequest, resp *provider.ConfigureResponse) { // Check environment variables apiToken := os.Getenv(envApiToken) endpoint := os.Getenv(envEndpoint) tenant := os.Getenv(envTenant) var data FusionAuthProviderModel // Read configuration data into model resp.Diagnostics.Append(req.Config.Get(ctx, \u0026data)...) if resp.Diagnostics.HasError() { return } // Configuration values are now available. if data.ApiToken.String() != \"\" { apiToken = data.ApiToken.String() } if apiToken == \"\" { resp.Diagnostics.AddError( \"Missing API Token Configuration\", \"While configuring the provider, the API token was not found in \"+ \"the \"+envApiToken+\" environment variable or provider \"+ \"configuration block api_token attribute.\", ) } if data.Endpoint.String() != \"\" { endpoint = data.Endpoint.String() } if endpoint == \"\" { resp.Diagnostics.AddError( \"Missing Endpoint Configuration\", \"While configuring the provider, the API endpoint was not found in \"+ \"the \"+envEndpoint+\" environment variable or provider \"+ \"configuration block endpoint attribute.\", ) } if data.Tenant.String() != \"\" { tenant = data.Tenant.String() } baseURL, err := url.Parse(endpoint) if err != nil { resp.Diagnostics.AddError( \"Unable to parse FusionAuth API Endpoint\", \"While configuring the provider, the API endpoint '\"+endpoint+\"'was unable \"+ \"to be parsed as a URL.\", ) } // Finalized validating config, return errors if resp.Diagnostics.HasError() { return } // client configuration for data sources and resources httpClient := \u0026http.Client{ Timeout: time.Second * 10, } client := FusionAuthClient{ API: fusionauth.NewClient(httpClient, baseURL, apiToken), Tenant: tenant, } // Bind in the client data resp.DataSourceData = client resp.ResourceData = client } Refer: https://github.com/matthewhartstonge/terraform-provider-fusionauth/blob/95cb893c5bb5e778a1af18592d0719e4492e732f/internal/provider/provider.go#L83-L153\nInterestingly, I don’t know if I’m meant to be plugging in a struct to resp.DataSourceData and resp.ResourceData as the “client” as that bit wasn’t clear, but no doubt I’ll find this out pretty quick when I crack back into this when building out my first Terraform FusionAuth Resource.\nAnywho, that’s where I got to for my first night.\nFollow along Feel free to follow along with my development at GitHub or chat via my socials:\nGithub - matthewhartstonge/terraform-provider-fusionauth LinkedIn Twitter Addendum Time to Code: 3h Time to Blog: 2h Realising I can plumb thumbnails into my blogs and backporting: 1h ","wordCount":"1004","inLanguage":"en","image":"https://blog.mykro.co.nz/images/developing-terraform-providers.jpeg","datePublished":"2023-07-12T21:59:45+12:00","dateModified":"2023-07-12T21:59:45+12:00","author":{"@type":"Person","name":"Matthew Hartstonge"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.mykro.co.nz/posts/2023-07-12-devlog-001/"},"publisher":{"@type":"Organization","name":"Matthew Hartstonge","logo":{"@type":"ImageObject","url":"https://secure.gravatar.com/avatar/0f1d4fae9524fdcf157f93b20a55a1ac?size=250"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.mykro.co.nz/ accesskey=h title="Matthew Hartstonge (Alt + H)">Matthew Hartstonge</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.mykro.co.nz/posts title=Blog><span>Blog</span></a></li><li><a href=https://blog.mykro.co.nz/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.mykro.co.nz/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Devlog: 001 - Building Terraform Providers</h1><div class=post-meta><span title='2023-07-12 21:59:45 +1200 NZST'>July 12, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;1004 words&nbsp;·&nbsp;Matthew Hartstonge</div></header><figure class=entry-cover><img loading=eager src=https://blog.mykro.co.nz/images/developing-terraform-providers.jpeg alt="A cloud being constructed by programmers climbing over it with ladders against an abstract background of code"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#providers>Providers</a></li><li><a href=#objectives>Objectives</a></li><li><a href=#starting-out>Starting Out</a></li><li><a href=#follow-along>Follow along</a></li><li><a href=#addendum>Addendum</a></li></ul></nav></div></details></div><div class=post-content><h1 id=terraform>Terraform<a hidden class=anchor aria-hidden=true href=#terraform>#</a></h1><p>If you&rsquo;ve been living under a rock or happen to be a newcomer in the DevOps/Site Reliability Engineering space, Hashicorp&rsquo;s <a href=https://terraform.io>Terraform</a> enables provisioning and managing cloud infrastructure. It&rsquo;s essentially a glorified diffing tool for any cloud resource that, as long as a Terraform Provider exists, can ensure the state of your infrastructure is as expected when written in Hashicorp Config Language (HCL).</p><p>As a forewarning before digging deeper, it has been common to hear some Linuxy sysadmin-looking neckbeards in-passing talking about infrastructure as code, better known as IaC, being the bee&rsquo;s knees and how they keep managing to give Dave a good ribbing after causing the Great Network failure of &lsquo;22 after performing a Git force push&mldr;</p><p>Terraform could be your new life.</p><p>It&rsquo;s a good one.</p><p>I digress&mldr;</p><p>The great thing about Terraform is that it provides for your infrastructure:</p><ul><li>Automated creation of new resources</li><li>Showing the difference between current and expected resources on <code>terraform plan</code></li><li>The ability to reconcile the current state with the written expectation on <code>terraform apply</code></li><li>And when used with Git, an auditable history of changes</li></ul><p>Plenty of Terraform Providers exist for cloud providers, for example, Azure, AWS, Digital Ocean and more! But while Terraform can manage Cloud Resources, it has been built so that, as long as you can interact with an API (create, read, update or delete) to adjust the state of a given &ldquo;Thing&rdquo;, it can be managed by Terraform.</p><h2 id=providers>Providers<a hidden class=anchor aria-hidden=true href=#providers>#</a></h2><p>Hashicorp has maintained a wonderfully extensible Terraform Plugin Software Development Kit (SDK) for creating Providers for many, many years and has recently journeyed into what it would look like to build an idiomatically Go, more streamlined, strongly typed framework with documentation generation for creating providers. If you want to dig into the weeds to understand the difference between the Plugin SDKv2 and the Plugin Framework, check out Hashicorp&rsquo;s article on the &ldquo;<a href=https://developer.hashicorp.com/terraform/plugin/framework-benefits>Plugin Framework Benefits</a>&rdquo;.</p><h2 id=objectives>Objectives<a hidden class=anchor aria-hidden=true href=#objectives>#</a></h2><p>At my place of employment, we have been using FusionAuth as our 3rd-party auth provider and a community-maintained Terraform Provider, which I have committed and pushed many a PR to.
While it works, there are several rough edges that would be nice to round out, plus I wanted to gain an appreciation of where Hashicorp is heading with the new framework.</p><p>My main objectives when starting this project are:</p><ul><li>Consistency - Ensuring that the project has a similar consistent pattern of solving common problems.</li><li>DX/UX - Ensure it provides a much better developer and user experience due to automatic documentation generation or better error suggestions.</li><li>Testability - Ensuring that the project has proper acceptance tests that show when the API of FusionAuth or the Go-Client has broken the Terraform Provider.</li></ul><h2 id=starting-out>Starting Out<a hidden class=anchor aria-hidden=true href=#starting-out>#</a></h2><p>Hashicorp kindly provides many good resources for creating your first Terraform Provider. The first thing I read through was Hashicorp&rsquo;s documentation on <a href=https://developer.hashicorp.com/terraform/plugin>Plugin Development</a>. I then cloned the <a href=/>Terraform Provider Scaffolding Framework</a> repo and proceeded to get myself versed in the repo&rsquo;s layout.</p><p>Interestingly, the Provider implementation is stored in an <code>internal</code> folder, meaning external developers can&rsquo;t import the Provider code. Not a bad thing, but it helps to force developers to use the Terraform Provider as a gRPC binary plugin assuming they don&rsquo;t want to copy+paste code.</p><p>Delving into <a href=https://github.com/hashicorp/terraform-provider-scaffolding-framework/blob/main/internal/provider/provider.go><code>internal/provider/provider.go</code></a> I started to build out my FusionAuth Provider config - enabling the configuration of a <code>Host Name</code> and <code>API Token</code>.</p><p>After an initial skeleton, I backtracked to the docs and found a helpful walkthrough article on <a href=https://developer.hashicorp.com/terraform/plugin/framework/providers>framework-based Providers</a>. The info gleaned here helped with initial provider configuration - using envvars and pulling data out from the config struct was pertinent to success. So that was neat to find.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>FusionAuthProvider</span><span class=p>)</span> <span class=nf>Configure</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>provider</span><span class=p>.</span><span class=nx>ConfigureRequest</span><span class=p>,</span> <span class=nx>resp</span> <span class=o>*</span><span class=nx>provider</span><span class=p>.</span><span class=nx>ConfigureResponse</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Check environment variables
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>apiToken</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=nx>envApiToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>endpoint</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=nx>envEndpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>tenant</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=nx>envTenant</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>data</span> <span class=nx>FusionAuthProviderModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Read configuration data into model
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>resp</span><span class=p>.</span><span class=nx>Diagnostics</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Config</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>data</span><span class=p>)</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Diagnostics</span><span class=p>.</span><span class=nf>HasError</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Configuration values are now available.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>ApiToken</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>apiToken</span> <span class=p>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>ApiToken</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>apiToken</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>resp</span><span class=p>.</span><span class=nx>Diagnostics</span><span class=p>.</span><span class=nf>AddError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;Missing API Token Configuration&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;While configuring the provider, the API token was not found in &#34;</span><span class=o>+</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;the &#34;</span><span class=o>+</span><span class=nx>envApiToken</span><span class=o>+</span><span class=s>&#34; environment variable or provider &#34;</span><span class=o>+</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;configuration block api_token attribute.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>endpoint</span> <span class=p>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>endpoint</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>resp</span><span class=p>.</span><span class=nx>Diagnostics</span><span class=p>.</span><span class=nf>AddError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;Missing Endpoint Configuration&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;While configuring the provider, the API endpoint was not found in &#34;</span><span class=o>+</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;the &#34;</span><span class=o>+</span><span class=nx>envEndpoint</span><span class=o>+</span><span class=s>&#34; environment variable or provider &#34;</span><span class=o>+</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;configuration block endpoint attribute.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>Tenant</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>tenant</span> <span class=p>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>Tenant</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>baseURL</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>url</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>endpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>resp</span><span class=p>.</span><span class=nx>Diagnostics</span><span class=p>.</span><span class=nf>AddError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;Unable to parse FusionAuth API Endpoint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;While configuring the provider, the API endpoint &#39;&#34;</span><span class=o>+</span><span class=nx>endpoint</span><span class=o>+</span><span class=s>&#34;&#39;was unable &#34;</span><span class=o>+</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;to be parsed as a URL.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Finalized validating config, return errors
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Diagnostics</span><span class=p>.</span><span class=nf>HasError</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// client configuration for data sources and resources
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>httpClient</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Timeout</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=o>*</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>FusionAuthClient</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>API</span><span class=p>:</span>    <span class=nx>fusionauth</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span><span class=nx>httpClient</span><span class=p>,</span> <span class=nx>baseURL</span><span class=p>,</span> <span class=nx>apiToken</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Tenant</span><span class=p>:</span> <span class=nx>tenant</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Bind in the client data
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>resp</span><span class=p>.</span><span class=nx>DataSourceData</span> <span class=p>=</span> <span class=nx>client</span>
</span></span><span class=line><span class=cl>	<span class=nx>resp</span><span class=p>.</span><span class=nx>ResourceData</span> <span class=p>=</span> <span class=nx>client</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Refer: <a href=https://github.com/matthewhartstonge/terraform-provider-fusionauth/blob/95cb893c5bb5e778a1af18592d0719e4492e732f/internal/provider/provider.go#L83-L153>https://github.com/matthewhartstonge/terraform-provider-fusionauth/blob/95cb893c5bb5e778a1af18592d0719e4492e732f/internal/provider/provider.go#L83-L153</a></p><p>Interestingly, I don&rsquo;t know if I&rsquo;m meant to be plugging in a struct to <code>resp.DataSourceData</code> and <code>resp.ResourceData</code> as the &ldquo;client&rdquo; as that bit wasn&rsquo;t clear, but no doubt I&rsquo;ll find this out pretty quick when I crack back into this when building out my first Terraform FusionAuth Resource.</p><p>Anywho, that&rsquo;s where I got to for my first night.</p><h2 id=follow-along>Follow along<a hidden class=anchor aria-hidden=true href=#follow-along>#</a></h2><p>Feel free to follow along with my development at GitHub or chat via my socials:</p><ul><li><a href=https://github.com/matthewhartstonge/terraform-provider-fusionauth>Github - matthewhartstonge/terraform-provider-fusionauth</a></li><li><a href=https://www.linkedin.com/in/matthewhartstonge/>LinkedIn</a></li><li><a href=https://twitter.com/matthartstonge>Twitter</a></li></ul><h2 id=addendum>Addendum<a hidden class=anchor aria-hidden=true href=#addendum>#</a></h2><ul><li>Time to Code: 3h</li><li>Time to Blog: 2h</li><li>Realising I can plumb thumbnails into my blogs and backporting: 1h</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.mykro.co.nz/tags/devops/>DevOps</a></li><li><a href=https://blog.mykro.co.nz/tags/go/>Go</a></li><li><a href=https://blog.mykro.co.nz/tags/golang/>Golang</a></li><li><a href=https://blog.mykro.co.nz/tags/programming/>Programming</a></li><li><a href=https://blog.mykro.co.nz/tags/softwaredevelopment/>SoftwareDevelopment</a></li><li><a href=https://blog.mykro.co.nz/tags/softwareengineering/>SoftwareEngineering</a></li><li><a href=https://blog.mykro.co.nz/tags/terraform/>Terraform</a></li><li><a href=https://blog.mykro.co.nz/tags/pluginframework/>PluginFramework</a></li><li><a href=https://blog.mykro.co.nz/tags/provider/>Provider</a></li></ul></footer></article></main><footer class=footer><span>© Copyright 2024 Matthew Hartstonge</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>